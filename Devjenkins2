pipeline {
    agent any

    stages {
        stage('Build') {
            when {
                expression {
                    return params.Build == 'Yes' || params.Deploy == 'Yes'
                }
            }
            steps {
                script {
                    if (!env.DEV_SERVER_MODULES?.trim()) {
                        error "DEV_SERVER_MODULES environment variable is required but was not set."
                    }
                    if (!env.DEV_SERVER_DIR?.trim()) {
                        error "DEV_SERVER_DIR environment variable is required but was not set."
                    }
                }
                echo 'Building..'
                 script {
                    sh "docker run --rm -t -u \$(id -u):\$(id -g) -e NWN_HOME=\$(pwd) -v \$(pwd):\$(pwd) -v \$(pwd):/nasher cltalmadge/nasher:amia pack dev --clean --verbose --yes"
                    archiveArtifacts artifacts: 'AmiaDev.mod', followSymlinks: false
                    sh "cp AmiaDev.mod ${env.DEV_SERVER_MODULES}/"
                }
            }
        }
        stage('Restart Dev Server') {
            when {
                expression {
                    return params.Restart == 'Yes'
                }
            }
            steps {
                withEnv(["AMIA_SERVER_DIR=${env.DEV_SERVER_DIR}".toString()]) {
                    sh 'bash deploy-dev2.sh'
                }
            }
        }
    }
}